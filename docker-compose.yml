version: '3.8'

services:
  # Cloud Test Server (Mock Registry)
  cloud-server:
    image: python:3.11-slim
    container_name: cloud-server
    working_dir: /app
    volumes:
      - ./cloud-test-server.py:/app/cloud-test-server.py
    command: sh -c "pip install flask && python cloud-test-server.py"
    ports:
      - "8080:8080"
    networks:
      - messaging-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Messaging Broker
  broker:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: messaging-broker
    environment:
      NODE_ID: broker-001
      BROKER_PORT: 9092
      HTTP_PORT: 8081
      DATA_DIR: /app/data
      REGISTRY_URL: http://cloud-server:8080
      JAVA_OPTS: "-Xms512m -Xmx2g -XX:+UseG1GC"
    ports:
      - "9092:9092"  # TCP broker port
      - "8081:8081"  # HTTP admin/metrics port
    volumes:
      - broker-data:/app/data
    networks:
      - messaging-network
    depends_on:
      - cloud-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Consumer 1: Price Quote
  consumer-price-quote:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-price-quote
    environment:
      CONSUMER_TYPE: price-quote
      CONSUMER_TOPICS: "prices-v1,reference-data-v5,non-promotable-products,prices-v4,minimum-price,deposit"
      CONSUMER_GROUP: price-quote-group
      CONSUMER_PORT: 8090
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8090:8090"
    volumes:
      - consumer-price-quote-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 2: Product Service Lite
  consumer-product-svc-lite:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-product-svc-lite
    environment:
      CONSUMER_TYPE: product-svc-lite
      CONSUMER_TOPICS: "product-base-document"
      CONSUMER_GROUP: product-svc-lite-group
      CONSUMER_PORT: 8091
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8091:8091"
    volumes:
      - consumer-product-svc-lite-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 3: Search Enterprise
  consumer-search-enterprise:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-search-enterprise
    environment:
      CONSUMER_TYPE: search-enterprise
      CONSUMER_TOPICS: "search-product"
      CONSUMER_GROUP: search-enterprise-group
      CONSUMER_PORT: 8092
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8092:8092"
    volumes:
      - consumer-search-enterprise-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 4: Tesco Location Service
  consumer-tesco-location-service:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-tesco-location-service
    environment:
      CONSUMER_TYPE: tesco-location-service
      CONSUMER_TOPICS: "location,location-clusters"
      CONSUMER_GROUP: tesco-location-service-group
      CONSUMER_PORT: 8093
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8093:8093"
    volumes:
      - consumer-tesco-location-service-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 5: Customer Order On Till
  consumer-customer-order-on-till:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-customer-order-on-till
    environment:
      CONSUMER_TYPE: customer-order-on-till
      CONSUMER_TOPICS: "selling-restrictions"
      CONSUMER_GROUP: customer-order-on-till-group
      CONSUMER_PORT: 8094
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8094:8094"
    volumes:
      - consumer-customer-order-on-till-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 6: Colleague Facts
  consumer-colleague-facts:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-colleague-facts
    environment:
      CONSUMER_TYPE: colleague-facts
      CONSUMER_TOPICS: "colleague-facts-jobs,colleague-facts-legacy"
      CONSUMER_GROUP: colleague-facts-group
      CONSUMER_PORT: 8095
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8095:8095"
    volumes:
      - consumer-colleague-facts-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 7: Loss Prevention API
  consumer-loss-prevention-api:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-loss-prevention-api
    environment:
      CONSUMER_TYPE: loss-prevention-api
      CONSUMER_TOPICS: "loss-prevention-configuration,loss-prevention-store-configuration,loss-prevention-product,loss-prevention-rule-config"
      CONSUMER_GROUP: loss-prevention-api-group
      CONSUMER_PORT: 8096
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8096:8096"
    volumes:
      - consumer-loss-prevention-api-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 8: Stored Value Services
  consumer-stored-value-services:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-stored-value-services
    environment:
      CONSUMER_TYPE: stored-value-services
      CONSUMER_TOPICS: "stored-value-services-banned-promotion,stored-value-services-active-promotion"
      CONSUMER_GROUP: stored-value-services-group
      CONSUMER_PORT: 8097
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8097:8097"
    volumes:
      - consumer-stored-value-services-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 9: Colleague Identity
  consumer-colleague-identity:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-colleague-identity
    environment:
      CONSUMER_TYPE: colleague-identity
      CONSUMER_TOPICS: "colleague-card-pin"
      CONSUMER_GROUP: colleague-identity-group
      CONSUMER_PORT: 8098
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8098:8098"
    volumes:
      - consumer-colleague-identity-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 10: Distributed Identity
  consumer-distributed-identity:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-distributed-identity
    environment:
      CONSUMER_TYPE: distributed-identity
      CONSUMER_TOPICS: "colleague-card-pin-v2"
      CONSUMER_GROUP: distributed-identity-group
      CONSUMER_PORT: 8099
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8099:8099"
    volumes:
      - consumer-distributed-identity-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 11: DCXP Content
  consumer-dcxp-content:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-dcxp-content
    environment:
      CONSUMER_TYPE: dcxp-content
      CONSUMER_TOPICS: "dcxp-content"
      CONSUMER_GROUP: dcxp-content-group
      CONSUMER_PORT: 8100
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8100:8100"
    volumes:
      - consumer-dcxp-content-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 12: Restriction Service On Tills
  consumer-restriction-service-on-tills:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-restriction-service-on-tills
    environment:
      CONSUMER_TYPE: restriction-service-on-tills
      CONSUMER_TOPICS: "restriction-rules"
      CONSUMER_GROUP: restriction-service-on-tills-group
      CONSUMER_PORT: 8101
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8101:8101"
    volumes:
      - consumer-restriction-service-on-tills-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Consumer 13: DCXP UGC
  consumer-dcxp-ugc:
    build:
      context: ./consumer-app
      dockerfile: Dockerfile
    container_name: consumer-dcxp-ugc
    environment:
      CONSUMER_TYPE: dcxp-ugc
      CONSUMER_TOPICS: "dcxp-ugc"
      CONSUMER_GROUP: dcxp-ugc-group
      CONSUMER_PORT: 8102
      BROKER_HOST: broker
      BROKER_PORT: 9092
      STORAGE_DATA_DIR: /app/consumer-data
    ports:
      - "8102:8102"
    volumes:
      - consumer-dcxp-ugc-data:/app/consumer-data
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - messaging-network
    depends_on:
      - broker
    restart: unless-stopped

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3000:3000"
    volumes:
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
      - grafana-data:/var/lib/grafana
    networks:
      - messaging-network
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  broker-data:
    driver: local
  consumer-price-quote-data:
    driver: local
  consumer-product-svc-lite-data:
    driver: local
  consumer-search-enterprise-data:
    driver: local
  consumer-tesco-location-service-data:
    driver: local
  consumer-customer-order-on-till-data:
    driver: local
  consumer-colleague-facts-data:
    driver: local
  consumer-loss-prevention-api-data:
    driver: local
  consumer-stored-value-services-data:
    driver: local
  consumer-colleague-identity-data:
    driver: local
  consumer-distributed-identity-data:
    driver: local
  consumer-dcxp-content-data:
    driver: local
  consumer-restriction-service-on-tills-data:
    driver: local
  consumer-dcxp-ugc-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

networks:
  messaging-network:
    driver: bridge
